<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Afb application writing - AGL Documentation</title>
        <link href="../../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../agl.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../../..">AGL Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../../..">Home</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">App framework</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../">Home</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Binder</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../FAQ/">FAQ</a>
</li>
            
<li class="active">
    <a href="./">Afb application writing</a>
</li>
            
<li >
    <a href="../afb-bindings-overview/">Afb bindings overview</a>
</li>
            
<li >
    <a href="../afb-bindings-writing/">Afb bindings writing</a>
</li>
            
<li >
    <a href="../afb-daemon-vocabulary/">Afb daemon vocabulary</a>
</li>
            
<li >
    <a href="../afb-events-guide/">Afb events guide</a>
</li>
            
<li >
    <a href="../afb-overview/">Afb overview</a>
</li>
            
<li >
    <a href="../afb-tests-overview/">Afb tests overview</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Main</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../main/afm-system-daemon/">Afm system daemon</a>
</li>
            
<li >
    <a href="../../main/afm-user-daemon/">Afm user daemon</a>
</li>
            
<li >
    <a href="../../main/application-framework/">Application framework</a>
</li>
            
<li >
    <a href="../../main/">Home</a>
</li>
            
<li >
    <a href="../../main/overview/">Overview</a>
</li>
            
<li >
    <a href="../../main/quick-tutorial/">Quick tutorial</a>
</li>
            
<li >
    <a href="../../main/security-framework/">Security framework</a>
</li>
            
<li >
    <a href="../../main/widgets/">Widgets</a>
</li>
            
<li >
    <a href="../../main/writing-config.xml/">Writing config.xml</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Audio</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../audio/">Home</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Sec blueprint</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../sec-blueprint/01-overview/">01 overview</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/02-plateform-security/">02 plateform security</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/03-security-concepts/">03 security concepts</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/04-adversaries/">04 adversaries</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/04-threat-analysis/">04 threat analysis</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/06-attack-surfaces/">06 attack surfaces</a>
</li>
            
<li >
    <a href="../../../sec-blueprint/">Home</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Signaling</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../signaling/architecture/">Architecture</a>
</li>
            
<li >
    <a href="../../../signaling/">Home</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Getting started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../user/getting-started/source-code/">Source code</a>
</li>
            
<li >
    <a href="../../../../user/getting-started/troubleshooting/">Troubleshooting</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Footers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../user/getting-started/footers/porter-footer/">Porter footer</a>
</li>
            
<li >
    <a href="../../../../user/getting-started/footers/raspberrypi-footer/">Raspberrypi footer</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Machines</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../user/getting-started/machines/porter/">Porter</a>
</li>
            
<li >
    <a href="../../../../user/getting-started/machines/qemu/">Qemu</a>
</li>
            
<li >
    <a href="../../../../user/getting-started/machines/raspberrypi/">Raspberrypi</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../FAQ/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../afb-bindings-overview/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/automotive-grade-linux/docs-agl">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#howto-write-an-application-above-agl-framework">HOWTO WRITE an APPLICATION above AGL FRAMEWORK</a></li>
            <li><a href="#programmation-languages-for-applications">Programmation Languages for Applications</a></li>
            <li><a href="#handling-sessions-within-applications">Handling sessions within applications</a></li>
            <li><a href="#format-of-replies">Format of replies</a></li>
            <li><a href="#format-of-events">Format of events</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="howto-write-an-application-above-agl-framework">HOWTO WRITE an APPLICATION above AGL FRAMEWORK</h1>
<h2 id="programmation-languages-for-applications">Programmation Languages for Applications</h2>
<h3 id="writing-an-html5-application">Writing an HTML5 application</h3>
<p>Developers of HTML5 applications (client side) can easily create
applications for AGL framework using their preferred
HTML5 framework.</p>
<p>Developers may also take advantage of powerful server side plugins to improve
application behavior. Server side plugins return an application/json mine-type
and can be accessed though either HTTP or Websockets.</p>
<p>In a near future, JSON-RPC protocol should be added to complete current x-afb-json1 protocol.</p>
<p>Two examples of HTML5 applications are given:</p>
<ul>
<li>
<p><a href="https://gerrit.automotivelinux.org/gerrit/gitweb?p=src/app-framework-demo.git;a=tree;f=afb-client">afb-client</a> a simple "hello world" application template</p>
</li>
<li>
<p><a href="https://gerrit.automotivelinux.org/gerrit/gitweb?p=src/app-framework-demo.git;a=tree;f=afm-client">afm-client</a> a simple "Home screen" application template</p>
</li>
</ul>
<h3 id="writing-a-qt-application">Writing a Qt application</h3>
<p>Writing Qt applications is also supported. Qt offers standard API to send request through HTTP or WebSockets.</p>
<p>It is also possible to write QML applications. A sample QML application [token-websock] is avaliable..</p>
<ul>
<li><a href="https://gerrit.automotivelinux.org/gerrit/gitweb?p=src/app-framework-binder.git;a=blob;f=test/token-websock.qml">token-websock</a>
a simple "hello world" application in QML</li>
</ul>
<h3 id="writing-c-application">Writing "C" application</h3>
<p>C applications can use afb-daemon binder through a websocket connection.</p>
<p>The library <strong>libafbwsc</strong> is provided for C clients that need
to connect with an afb-daemon binder.</p>
<p>The program <strong>afb-client-demo</strong> is the C example that use
<strong>libafbwsc</strong> library.
Source code is available here
<a href="https://gerrit.automotivelinux.org/gerrit/gitweb?p=src/app-framework-binder.git;a=blob;f=src/afb-client-demo.c">src/afb-client-demo.c</a>.</p>
<p>Current implementation relies on libsystemd and file descriptors.
This model might be review in the future to support secure sockets
and free the dependency with libsystemd.</p>
<h2 id="handling-sessions-within-applications">Handling sessions within applications</h2>
<p>Applications should understand sessions and tokens management when interacting with afb-daemon binder.</p>
<p>Applications are communicating with their private binder(afb-daemon) using
a network connection or potentially any other connection channel. While current version
does not yet implement unix domain this feature might be added in a near future.
Developers need to be warn that HTTP protocol is a none connected protocol. This prevents
from using HTTP socket connection to authenticate clients.</p>
<p>For this reason, the binder should authenticate the application
by using a shared secret. The secret is named "token" and the identification
of client is named "session".</p>
<p>The examples <strong>token-websock.qml</strong> and <strong>afb-client</strong> are demonstrating
how authentication and sessions are managed.</p>
<h3 id="handling-sessions">Handling sessions</h3>
<p>Plugins and other binder feature need to keep track of client
instances. This is especially important for plugins running as services
as they may typically have to keep each client's data separated.</p>
<p>For HTML5 applications, the web runtime handles the cookie of session
that the binder afb-daemon automatically sets.</p>
<p>Session identifier can be set using the parameter
<strong>uuid</strong> or <strong>x-afb-uuid</strong> in URI requests. Within current version of the
framework session UUID is supported by both HTTP requests and websocket negotiation.</p>
<h3 id="exchanging-tokens">Exchanging tokens</h3>
<p>At application start, AGL framework communicates a shared secret to both binder
and client application. This initial secret is called the "initial token".</p>
<p>For each of its client application, the binder manages a current active
token for session management. This authentication token can be use to restrict
access to some plugin's methods.</p>
<p>The token must be included in URI request on HTTP or during websockets
connection using parameter <strong>token</strong> or <strong>x-afb-token</strong>.</p>
<p>To ensure security, tokens must be refreshed periodically.</p>
<h3 id="example-of-session-management">Example of session management</h3>
<p>In following examples, we suppose that <strong>afb-daemon</strong> is launched with something equivalent to:</p>
<pre><code>$ afb-daemon --port=1234 --token=123456 [...]
</code></pre>
<p>making the expectation that <strong>AuthLogin</strong> plugin is requested as default.</p>
<h4 id="using-curl">Using curl</h4>
<p>First, connects with the initial token, 123456:</p>
<pre><code>$ curl http://localhost:1234/api/auth/connect?token=123456
{
  "jtype": "afb-reply",
  "request": {
     "status": "success",
     "token": "0aef6841-2ddd-436d-b961-ae78da3b5c5f",
     "uuid": "850c4594-1be1-4e9b-9fcc-38cc3e6ff015"
  },
  "response": {"token": "A New Token and Session Context Was Created"}
}
</code></pre>
<p>It returns an answer containing session UUID, 850c4594-1be1-4e9b-9fcc-38cc3e6ff015,
and a refreshed token, 850c4594-1be1-4e9b-9fcc-38cc3e6ff015.</p>
<p>Check if session and token is valid:</p>
<pre><code>$ curl http://localhost:1234/api/auth/check?token=0aef6841-2ddd-436d-b961-ae78da3b5c5f\&amp;uuid=850c4594-1be1-4e9b-9fcc-38cc3e6ff015
{
  "jtype": "afb-reply",
  "request": {"status":"success"},
  "response": {"isvalid":true}
}
</code></pre>
<p>Refresh the token:</p>
<pre><code>$ curl http://localhost:1234/api/auth/refresh?token=0aef6841-2ddd-436d-b961-ae78da3b5c5f\&amp;uuid=850c4594-1be1-4e9b-9fcc-38cc3e6ff015
{
  "jtype": "afb-reply",
  "request": {
     "status":"success",
     "token":"b8ec3ec3-6ffe-448c-9a6c-efda69ad7bd9"
  },
  "response": {"token":"Token was refreshed"}
}
</code></pre>
<p>Close the session:</p>
<pre><code>curl http://localhost:1234/api/auth/logout?token=b8ec3ec3-6ffe-448c-9a6c-efda69ad7bd9\&amp;uuid=850c4594-1be1-4e9b-9fcc-38cc3e6ff015
{
  "jtype": "afb-reply",
  "request": {"status": "success"},
  "response": {"info":"Token and all resources are released"}
}
</code></pre>
<p>Checking on closed session for uuid should be refused:</p>
<pre><code>curl http://localhost:1234/api/auth/check?token=b8ec3ec3-6ffe-448c-9a6c-efda69ad7bd9\&amp;uuid=850c4594-1be1-4e9b-9fcc-38cc3e6ff015
{
  "jtype": "afb-reply",
  "request": {
     "status": "failed",
     "info": "invalid token's identity"
  }
}
</code></pre>
<h4 id="using-afb-client-demo">Using afb-client-demo</h4>
<blockquote>
<p>The program is packaged within AGL in the rpm <strong>libafbwsc-dev</strong></p>
</blockquote>
<p>Here is an example of exchange using <strong>afb-client-demo</strong>:</p>
<pre><code>$ afb-client-demo ws://localhost:1234/api?token=123456
auth connect
ON-REPLY 1:auth/connect: {"jtype":"afb-reply","request":{"status":"success",
   "token":"63f71a29-8b52-4f9b-829f-b3028ba46b68","uuid":"5fcc3f3d-4b84-4fc7-ba66-2d8bd34ae7d1"},
   "response":{"token":"A New Token and Session Context Was Created"}}
auth check
ON-REPLY 2:auth/check: {"jtype":"afb-reply","request":{"status":"success"},"response":{"isvalid":true}}
auth refresh
ON-REPLY 4:auth/refresh: {"jtype":"afb-reply","request":{"status":"success",
   "token":"8b8ba8f4-1b0c-48fa-962d-4a00a8c9157e"},"response":{"token":"Token was refreshed"}}
auth check
ON-REPLY 5:auth/check: {"jtype":"afb-reply","request":{"status":"success"},"response":{"isvalid":true}}
auth refresh
ON-REPLY 6:auth/refresh: {"jtype":"afb-reply","request":{"status":"success",
   "token":"e83b36f8-d945-463d-b983-5d8ed73ba529"},"response":{"token":"Token was refreshed"}}
</code></pre>
<p>After closing connection, reconnect as here after:</p>
<pre><code>$ afb-client-demo ws://localhost:1234/api?token=e83b36f8-d945-463d-b983-5d8ed73ba529\&amp;uuid=5fcc3f3d-4b84-4fc7-ba66-2d8bd34ae7d1 auth check
ON-REPLY 1:auth/check: {"jtype":"afb-reply","request":{"status":"success"},"response":{"isvalid":true}}
</code></pre>
<p>Same connection check using <strong>curl</strong>:</p>
<pre><code>$ curl http://localhost:1234/api/auth/check?token=e83b36f8-d945-463d-b983-5d8ed73ba529\&amp;uuid=5fcc3f3d-4b84-4fc7-ba66-2d8bd34ae7d1
{"jtype":"afb-reply","request":{"status":"success"},"response":{"isvalid":true}}
</code></pre>
<h2 id="format-of-replies">Format of replies</h2>
<p>Replies use javascript object returned as serialized JSON.</p>
<p>This object contains at least 2 mandatory fields of name <strong>jtype</strong> and <strong>request</strong>
and one optional field of name <strong>response</strong>.</p>
<h3 id="template">Template</h3>
<p>This is a template of replies:</p>
<pre><code class="json">{
   &quot;jtype&quot;: &quot;afb-reply&quot;,
   &quot;request&quot;: {
      &quot;status&quot;: &quot;success&quot;,
      &quot;info&quot;: &quot;informationnal text&quot;,
      &quot;token&quot;: &quot;e83b36f8-d945-463d-b983-5d8ed73ba52&quot;,
      &quot;uuid&quot;: &quot;5fcc3f3d-4b84-4fc7-ba66-2d8bd34ae7d1&quot;,
      &quot;reqid&quot;: &quot;application-generated-id-23456&quot;
   },
   &quot;response&quot;: ....any response object....
}
</code></pre>

<h3 id="field-jtype">Field jtype</h3>
<p>The field <strong>jtype</strong> must have a value of type string equal to <strong>"afb-reply"</strong>.</p>
<h3 id="field-request">Field request</h3>
<p>The field <strong>request</strong> must have a value of type object. This request object
has at least one field named <strong>status</strong> and four optional fields named
<strong>info</strong>, <strong>token</strong>, <strong>uuid</strong>, <strong>reqid</strong>.</p>
<h4 id="subfield-requeststatus">Subfield request.status</h4>
<p><strong>status</strong> must have a value of type string. This string is equal to <strong>"success"</strong>
only in case of success.</p>
<h4 id="subfield-requestinfo">Subfield request.info</h4>
<p><strong>info</strong> is of type string and represent optional information added to the reply.</p>
<h4 id="subfield-requesttoken">Subfield request.token</h4>
<p><strong>token</strong> is of type string. It is sent either at session creation 
or when the token is refreshed.</p>
<h4 id="subfield-requestuuid">Subfield request.uuid</h4>
<p><strong>uuid</strong> is of type string. It is sent at session creation.</p>
<h4 id="subfield-requestreqid">Subfield request.reqid</h4>
<p><strong>reqid</strong> is of type string. It is sent in response to HTTP requests
that added a parameter of name <strong>reqid</strong> or <strong>x-afb-reqid</strong> at request time.
Value returns in the reply has the exact same value as the one received in the request.</p>
<h3 id="field-response">Field response</h3>
<p>This field response optionally contains an object returned when request succeeded.</p>
<h2 id="format-of-events">Format of events</h2>
<p>Events are javascript object serialized as JSON.</p>
<p>This object contains at least 2 mandatory fields of name <strong>jtype</strong> and <strong>event</strong>
and one optional field of name <strong>data</strong>.</p>
<h3 id="template_1">Template</h3>
<p>Here is a template of event:</p>
<pre><code class="json">{
   &quot;jtype&quot;: &quot;afb-event&quot;,
   &quot;event&quot;: &quot;sample_api_name/sample_event_name&quot;,
   &quot;data&quot;: ...any event data...
}
</code></pre>

<h3 id="field-jtype_1">Field jtype</h3>
<p>The field <strong>jtype</strong> must have a value of type string equal to <strong>"afb-event"</strong>.</p>
<h3 id="field-event">Field event</h3>
<p>The field <strong>event</strong> carries the event's name.</p>
<p>The name of the event is made of two parts separated by a slash:
the name of the name of the API that generated the event
and the name of event within the API.</p>
<h3 id="field-data">Field data</h3>
<p>This field data if present holds the data carried by the event.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../../../..';</script>
        <script data-main="../../../../mkdocs/js/search.js" src="../../../../mkdocs/js/require.js"></script>
        <script src="../../../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
